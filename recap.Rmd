---
title: "FY24-FY28 Recapitalization Plan"

output:
  html_document:
    theme: flatly
    toc: false
    toc_float: false
    collapsed: false
    number_sections: false
    toc_depth: 2
    code_folding: none
params:
  date: "Dec 28, 2021"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE, 
                      cache = TRUE, 
                      echo = FALSE,
                      fig.width = 10, 
                      fig.height=5)

unlink('recap', recursive = TRUE)
```

```{css headings, echo=FALSE}

h1 {
  font-weight: bold;
  font-size: 28px;
  text-align: center;
}

h2 {
  font-weight: bold;
  font-size: 22px;
    text-align: center;
}

h3 {
  font-weight: bold;
  font-size: 24px;
}

h4 {
  font-weight: bold;
  font-size: 20px;
}

h5 {
  font-weight: bold;
  font-size: 16px;
}

```

```{r load-lib}
library(tidyverse)
library(ggthemes)
library(readxl)
library(DT)
library(gt)
library(tidyquant)
library(markdown)
library(writexl)


```


```{r input}

recap_plan <- read_xlsx(path = "/Users/barnesj/OneDrive - USMC-MCCS.ORG/Documents/Data/Github_data/output/df_final.xlsx")
  
recap_cycle <- read_xlsx(path = "/Users/barnesj/OneDrive - USMC-MCCS.ORG/Documents/Data/Github_data/MCCS_Facility_Inventory_Report.XLSX",
    sheet = "Cat_code"
)


```

```{r filter}
recap <- recap_plan %>% 
  janitor::clean_names() %>% 
  left_join(recap_cycle)

#Filter out facilities/utilizations that are not planned to be recapped using key word search
recap <- 
  recap %>% 
  # Facility Description
  mutate(plan = case_when(str_detect(facility_desc, "Pavilion") ~ "No-Recap",
  str_detect(facility_desc,"Storage")  ~ "No-Recap",
  str_detect(facility_desc, "Pier") ~ "No-Recap",
  str_detect(facility_desc, "Kennel") ~ "No-Recap", 
  str_detect(facility_desc, "POV") ~ "No-Recap",
  str_detect(facility_desc,"Stable") ~ "No-Recap", 
  str_detect(facility_desc,"Public Restroom") ~ "No-Recap",
  str_detect(facility_desc,"Overhead Cover") ~ "No-Recap", 
  str_detect(facility_desc, "Outdoor Theater") ~ "No-Recap", 
  str_detect(facility_desc, "Court") ~ "No-Recap",
  str_detect(facility_desc, "Playground") ~ "No-Recap",
  str_detect(facility_desc, "Outdoor Recreation Area") ~ "No-Recap",
  str_detect(facility_desc, "Field") ~ "No-Recap",
  # Asset Name
  str_detect(asset_name, "STORAGE") ~ "No-Recap",
  str_detect(asset_name, "VACANT") ~ "No-Recap",
  str_detect(asset_name, "CANOPY") ~ "No-Recap",
  str_detect(asset_name, "TRAILER") ~ "No-Recap", 
  str_detect(asset_name, "SHELTER") ~ "No-Recap",
  str_detect(asset_name, "SHED") ~ "No-Recap",
  str_detect(asset_name, "STRG") ~ "No-Recap",
  str_detect(asset_name, "COURT") ~ "No-Recap",
  str_detect(asset_name, "COURTS") ~ "No-Recap",
  str_detect(asset_name, "FIELD") ~ "No-Recap",
  str_detect(asset_name,"PICNIC") ~ "No-Recap",
  str_detect(asset_name, "POND") ~ "No-Recap",
  # str_detect(asset_name, "BATH HOUSE") ~ "No-Recap",
  str_detect(asset_name, "REC GROUND") ~ "No-Recap",
  str_detect(asset_name, "PUMP") ~ "No-Recap",
  str_detect(asset_name, "TRAIL") ~ "No-Recap",
  str_detect(asset_name, "REC AREA") ~ "No-Recap",
  str_detect(asset_name, "TRACK") ~ "No-Recap",
  str_detect(asset_name, "RV STORAGE") ~ "No-Recap",
  str_detect(asset_name, "SHED") ~ "No-Recap",
  str_detect(asset_name, "GAZEBO") ~ "No-Recap",
  #Facility Use
  str_detect(fac_use, "VACANT") ~ "No-Recap",
  str_detect(fac_use, "TURN OVER") ~ "No-Recap",
  str_detect(fac_use, "TRANSFERRED") ~ "No-Recap",
  str_detect(fac_use, "STORAGE") ~ "No-Recap",
  
  # Facility Number 
  str_detect(fac_num, "T") ~ "No-Recap",
  #Adding back facilities to recap plan that were removed by plain text above
  str_detect(facility_desc, "Indoor Physical Fitness Facility") ~ "Planned ReCap",
 
  
  #Discrepancy
  str_detect(facility_desc, "Transient  Lodging") ~ "Discrepancy",
  str_detect(asset_name, "UNACC ENL HSG") ~ "Discrepancy",
  str_detect(asset_name, "SCOUT BLDG")  ~ "Discrepancy",
  str_detect(asset_name, "HSG") ~ "Discrepancy",
  str_detect(asset_name, "BHC")  ~ "Discrepancy",
  str_detect(asset_name, "MOUT")  ~ "Discrepancy",
  
  TRUE ~ "Planned ReCap"
)) %>% 
  # convert dates to YMD format
   mutate(fci_dt = fci_dt %>% ymd(),
         build_dt = build_dt %>% ymd()
         )
           
write_xlsx(recap, "/Users/barnesj/OneDrive - USMC-MCCS.ORG/Documents/Data/Github_data/output/recap.xlsx")        
    

```

```{r recap}
#Create a Cat C ReCap Only List

cat_c_recap <- recap %>% 
  filter(naf_cat == "C" & plan == "Planned ReCap") %>% 
  mutate(fci_dt = fci_dt %>% ymd(),
         build_dt = build_dt %>% ymd()
         )
# If utilizations are in same facililty get the min cycle time
min_cycle <- cat_c_recap %>% 
  group_by(rpuid) %>% 
  summarise(min_cycle = recap_cycle %>% min())

# Join min cycle time to date frame, if any
cat_c_recap <- cat_c_recap %>% 
  left_join(min_cycle) %>% 
  mutate(min_cycle = if_else(min_cycle <= 7, 7, min_cycle)) %>% 
  arrange(min_cycle, fci, desc(fci_dt), desc(rpuid))

write_xlsx(cat_c_recap, "/Users/barnesj/OneDrive - USMC-MCCS.ORG/Documents/Data/Github_data/output/cat_c_recap.xlsx")


```

```{r schedule}

#Create a Schedule

cat_c_recap_7 <- cat_c_recap %>% 
  filter(min_cycle == 7) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 7))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*7 ~ 7),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*2 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*3 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*4 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*5 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*6 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*7 ~ 14),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*2 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*3 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*4 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*5 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*6 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 7) %>%  nrow()/7*7 ~ 21))
                                 
cat_c_recap_8 <- cat_c_recap %>% 
  filter(min_cycle == 8) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 8))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*8 ~ 8),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*2 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*3 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*4 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*5 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*6 ~ 14,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*7 ~ 15,
                                   index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*8 ~ 16),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*2 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*3 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*4 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*5 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*6 ~ 22,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*7 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 8) %>%  nrow()/8*8 ~ 24)) 



cat_c_recap_9 <- cat_c_recap %>% 
  filter(min_cycle == 9) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 9))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*8 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*9 ~ 9),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*2 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*3 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*4 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*5 ~ 14,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*6 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*7 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*8 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*9 ~ 18),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*2 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*3 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*4 ~ 22,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*5 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*6 ~ 24,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*7 ~ 25,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*8 ~ 26,
                                  index <= cat_c_recap %>% filter(min_cycle == 9) %>%  nrow()/9*9 ~ 27))

cat_c_recap_10 <- cat_c_recap %>% 
  filter(min_cycle == 10) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 10))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*8 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*9 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*10 ~ 10),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*2 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*3 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*4 ~ 14,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*5 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*6 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*7 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*8 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*9 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*10 ~ 20),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*2 ~ 22,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*3 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*4 ~ 24,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*5 ~ 25,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*6 ~ 26,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*7 ~ 27,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*8 ~ 28,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*9 ~ 29,
                                  index <= cat_c_recap %>% filter(min_cycle == 10) %>%  nrow()/10*10 ~ 30))


cat_c_recap_11 <- cat_c_recap %>% 
  filter(min_cycle == 11) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 11))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*8 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*9 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*10 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*11 ~ 11),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*2 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*3 ~ 14,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*4 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*5 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*6 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*7 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*8 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*9 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*10 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*11 ~ 22),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*2 ~ 24,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*3 ~ 25,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*4 ~ 26,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*5 ~ 27,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*6 ~ 28,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*7 ~ 29,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*8 ~ 30,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*9 ~ 31,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*10 ~ 32,
                                  index <= cat_c_recap %>% filter(min_cycle == 11) %>%  nrow()/11*11 ~ 33))


cat_c_recap_12 <- cat_c_recap %>% 
  filter(min_cycle == 12) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 12))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*8 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*9 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*10 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*11 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*12 ~ 12),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*2 ~ 14,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*3 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*4 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*5 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*6 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*7 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*8 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*9 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*10 ~ 22,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*11 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*12 ~ 24),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12 ~ 25,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*2 ~ 26,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*3 ~ 27,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*4 ~ 28,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*5 ~ 29,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*6 ~ 30,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*7 ~ 31,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*8 ~ 32,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*9 ~ 33,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*10 ~ 34,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*11 ~ 35,
                                  index <= cat_c_recap %>% filter(min_cycle == 12) %>%  nrow()/12*12 ~ 36))


cat_c_recap_13 <- cat_c_recap %>% 
  filter(min_cycle == 13) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 13))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*8 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*9 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*10 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*11 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*12 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*13 ~ 13),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13 ~ 14,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*2 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*3 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*4 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*5 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*6 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*7 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*8 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*9 ~ 22,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*10 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*11 ~ 24,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*12 ~ 25,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*13 ~ 26),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13 ~ 27,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*2 ~ 28,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*3 ~ 29,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*4 ~ 30,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*5 ~ 31,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*6 ~ 32,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*7 ~ 33,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*8 ~ 34,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*9 ~ 35,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*10 ~ 36,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*11 ~ 37,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*12 ~ 38,
                                  index <= cat_c_recap %>% filter(min_cycle == 13) %>%  nrow()/13*13 ~ 39))

cat_c_recap_14 <- cat_c_recap %>% 
  filter(min_cycle == 14) %>% 
  mutate(index = index(cat_c_recap %>% filter(min_cycle == 14))) %>% 
  mutate(plan_cycle_1 = case_when(index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14 ~ 1,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*2 ~ 2,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*3 ~ 3,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*4 ~ 4,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*5 ~ 5,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*6 ~ 6,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*7 ~ 7,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*8 ~ 8,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*9 ~ 9,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*10 ~ 10,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*11 ~ 11,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*12 ~ 12,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*13 ~ 13,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*14 ~ 14),
         plan_cycle_2 = case_when(index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14 ~ 15,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*2 ~ 16,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*3 ~ 17,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*4 ~ 18,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*5 ~ 19,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*6 ~ 20,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*7 ~ 21,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*8 ~ 22,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*9 ~ 23,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*10 ~ 24,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*11 ~ 25,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*12 ~ 26,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*13 ~ 27,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*14 ~ 28),
         plan_cycle_3 = case_when(index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14 ~ 29,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*2 ~ 30,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*3 ~ 31,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*4 ~ 32,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*5 ~ 33,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*6 ~ 34,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*7 ~ 35,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*8 ~ 36,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*9 ~ 37,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*10 ~ 38,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*11 ~ 39,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*12 ~ 40,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*13 ~ 41,
                                  index <= cat_c_recap %>% filter(min_cycle == 14) %>%  nrow()/14*14 ~ 42))



cat_c_recap <- cat_c_recap_7 %>% 
  union(cat_c_recap_8) %>% 
  union(cat_c_recap_9) %>% 
  union(cat_c_recap_10) %>% 
  union(cat_c_recap_11) %>% 
  union(cat_c_recap_12) %>% 
  union(cat_c_recap_13) %>% 
  union(cat_c_recap_14) %>% 
  mutate(FY24 = case_when(plan_cycle_1 == 1 ~ 1, TRUE ~ 0),
         FY25 = case_when(plan_cycle_1 == 2 ~ 1, TRUE ~ 0),
         FY26 = case_when(plan_cycle_1 == 3 ~ 1, TRUE ~ 0),
         FY27 = case_when(plan_cycle_1 == 4 ~ 1, TRUE ~ 0),
         FY28 = case_when(plan_cycle_1 == 5 ~ 1, TRUE ~ 0),
         FY29 = case_when(plan_cycle_1 == 6 ~ 1, TRUE ~ 0),
         FY30 = case_when(plan_cycle_1 == 7 ~ 1, TRUE ~ 0),
         FY31 = case_when(plan_cycle_1 == 8  | plan_cycle_2 == 8 ~ 1, TRUE ~ 0),
         FY32 = case_when(plan_cycle_1 == 9  | plan_cycle_2 == 9 ~ 1, TRUE ~ 0),
         FY33 = case_when(plan_cycle_1 == 10 | plan_cycle_2 == 10 ~ 1, TRUE ~ 0),
         FY34 = case_when(plan_cycle_1 == 11 | plan_cycle_2 == 11 ~ 1, TRUE ~ 0),
         FY35 = case_when(plan_cycle_1 == 12 | plan_cycle_2 == 12 ~ 1, TRUE ~ 0),
         FY36 = case_when(plan_cycle_1 == 13 | plan_cycle_2 == 13 ~ 1, TRUE ~ 0),
         FY37 = case_when(plan_cycle_1 == 14 | plan_cycle_2 == 14 ~ 1, TRUE ~ 0),
         FY38 = case_when(plan_cycle_1 == 15 | plan_cycle_2 == 15 | plan_cycle_3 == 15 ~ 1, TRUE ~ 0),
         FY39 = case_when(plan_cycle_1 == 16 | plan_cycle_2 == 16 | plan_cycle_3 == 16 ~ 1, TRUE ~ 0),
         FY40 = case_when(plan_cycle_1 == 17 | plan_cycle_2 == 17 | plan_cycle_3 == 17 ~ 1, TRUE ~ 0),
         FY41 = case_when(plan_cycle_1 == 18 | plan_cycle_2 == 18 | plan_cycle_3 == 18 ~ 1, TRUE ~ 0),
         FY42 = case_when(plan_cycle_1 == 19 | plan_cycle_2 == 19 | plan_cycle_3 == 19 ~ 1, TRUE ~ 0),
         FY43 = case_when(plan_cycle_1 == 20 | plan_cycle_2 == 20 | plan_cycle_3 == 20 ~ 1, TRUE ~ 0))

write_xlsx(cat_c_recap, "/Users/barnesj/OneDrive - USMC-MCCS.ORG/Documents/Data/Github_data/output/cat_c_recap.xlsx")



```


```{r}
fydp_recap <- cat_c_recap %>% 
  select(-FY29, -FY30, -FY31, -FY32, -FY33, -FY34, -FY35, -FY36, -FY37, -FY38, -FY39, -FY40, -FY41, -FY42, -FY43) %>% 
  filter(FY24 == 1 | FY25 == 1 | FY26 == 1 | FY27 == 1 | FY28 == 1)

```



<br>

<center>

Note: The current report is based on utilization information unless otherwise noted. 

Category C Facility Recapitalization Plan 

Data dictionary and assumptions are at the end of this report


Raw data pulled from GoRPM on `r params$date`


<!-- Download raw data: [here](https://mccsorg-my.sharepoint.com/:x:/g/personal/jason_barnes_usmc-mccs_org/EQ2Kicc4IapDi0aJDUetkCUB4ObLD-WCMv8gLEdScQ2KuQ?e=erfL6q) -->


<!-- Download cleaned data: [here](https://mccsorg-my.sharepoint.com/:x:/g/personal/jason_barnes_usmc-mccs_org/Ebjf72UBqQBBqjhUPGwIjaoBQ1IlOxjEzcai-Gw-kairFA?e=fQrtm9) -->

</center>

<br>

## Planned Recap Data Table

```{r}

fydp_plan <- fydp_recap %>% 
  select(installation, facility_desc, fac_use, rpuid, fac_num, fci, FY24:FY28) %>% 
  datatable(
    colnames = c("Installation", "Facility Description", "Facility Use", "RPUID", "Facility Num", "FCI", "FY24", "FY25","FY26", "FY27", "FY28"),
    options = list(
      columnDefs = list(list(className = "dt-center", targets = 0:11)),
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'background-color': '#2c3e50', 'color': '#fff'});",
        "}"
      )
    )
  ) 

fydp_plan




```

<br>

---

## Projects

<br>

```{r}
#use description
proj_use <- fydp_recap %>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  filter(count == 1) %>% 
  group_by(use_desc) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(use_desc = use_desc %>% as_factor() %>% fct_reorder(total)) %>% 
  ggplot(aes(use_desc,total)) +
  geom_col(fill = "#2c3e50")+
  coord_flip()+
  labs(y = "Total number of scheduled projects FY24-FY28",
       x = "Use Description
       ") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0)
  )




# Facility Description 
proj_fac <- fydp_recap %>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  filter(count == 1) %>% 
  group_by(facility_desc) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(facility_desc = facility_desc %>% as_factor() %>% fct_reorder(total)) %>% 
  ggplot(aes(facility_desc,total)) +
  geom_col(fill = "#2c3e50")+
  coord_flip()+
  labs(y = "Total number of scheduled projects FY24-FY28",
       x = "Facility Description") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0)
  )




# By Operating Activity

proj_op <- fydp_recap%>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  filter(count == 1) %>% 
  group_by(op_activity) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(op_activity = op_activity %>% as_factor() %>% fct_reorder(total)) %>% 
  ggplot(aes(op_activity, total)) +
  geom_col(fill = "#2c3e50")+
  coord_flip()+
  labs(y = "Total number of scheduled projects FY24-FY28",
       x = "") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0)
  )



# By Region

proj_region <- fydp_recap %>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  filter(count == 1) %>% 
  group_by(region) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(region = region %>% as_factor() %>% fct_reorder(total)) %>% 
  ggplot(aes(region, total)) +
  geom_col(fill = "#2c3e50")+
  coord_flip()+
  labs(y = "Total number of scheduled projects FY24-FY28",
       x = "") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0)
  )

proj_region

# By installation

proj_inst <- fydp_recap %>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  filter(count == 1) %>% 
  group_by(installation) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(installation = installation %>% as_factor() %>% fct_reorder(total)) %>% 
  ggplot(aes(installation, total)) +
  geom_col(fill = "#2c3e50")+
  coord_flip()+
  labs(y = "Total number of scheduled projects FY24-FY28",
       x = "") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0)
  )



```


```{r}
recap_op_fy <- fydp_recap %>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  ggplot(aes(year,count, fill = op_activity)) +
  geom_col() + 
  scale_fill_brewer() +
  labs(title = "Total number of scheduled projects by FY and Operating Activity (FY24-FY28)",
       y = "",
       x = "") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.x =  element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0),
    legend.title = element_blank()
  )


recap_op_fy

recap_facet <- fydp_recap %>% 
  pivot_longer(cols= starts_with("FY"), names_to = "year", values_to = "count") %>% 
  ggplot(aes(year,count)) +
  geom_col(fill = "#2c3e50") + 
  facet_wrap(~op_activity) +
  labs(title = "Total number of scheduled projects by FY and Operating Activity (FY24-FY28)
       ",
       y = "",
       x = "") +
  theme_tq() +
  theme(
    # panel.grid.major = element_blank(),
    panel.grid.major.x =  element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = 0),
    legend.title = element_blank()
  )



```

