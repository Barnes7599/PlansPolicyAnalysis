---
title: |

  ![](images/16_MCCSlogo_Comp.png){width=2in}  

  MCCS Facilities Exploratory Analysis  
  
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

```{r}

# File Setup ----

library(tidyverse)
library(ggthemes)
library(ggrepel)
library(extrafont)
library(readxl)
library(DT)
library(gt)
library(DataExplorer)
library(tidyquant)
library(markdown)
library(writexl)


cat_codes <- read_xlsx("/Users/barnesj/OneDrive - USMC-MCCS.ORG/Utilization/iNFADS/Data/MCCS_Facility_ Inventory_Report.XLSX",
  sheet = "Cat_code",
  col_types = c("numeric", "text", "text", "text")
)

fac <- read_xlsx("/Users/barnesj/OneDrive - USMC-MCCS.ORG/Utilization/iNFADS/Data/MCCS_Facility_ Inventory_Report.XLSX",
  sheet = "Facility",
  skip = 1,
  col_types = c(
    "text", "text", "text", "text", "text",
    "numeric", "numeric", "date", "text", "date",
    "date"
  )
)

# infads <- read_rds("/Users/barnesj/OneDrive - USMC-MCCS.ORG/Utilization/iNFADS/Data/infads_clean") # read in the cleaned data

utl <- read_xlsx("/Users/barnesj/OneDrive - USMC-MCCS.ORG/Utilization/iNFADS/Data/MCCS_Facility_ Inventory_Report.XLSX",
  sheet = "Sheet1",
  skip = 1
)

fac <- fac %>%
  janitor::clean_names() %>%
  separate(mccs_installation_name, c("num", "installation"), sep = 7) %>%
  separate(i_nfads_predominant_current_use_category_code, c("usecode", "usedesc"), sep = 6) %>%
  select(
    RPUID = i_nfads_real_property_unique_id,
    usecode,
    usedesc,
    installation,
    prv = i_nfads_current_prv,
    fci = i_nfads_facility_condition_index,
    fci_dt = i_nfads_fci_date,
    build_dt = i_nfads_facility_built_date
  ) %>%
  # coverting dates to ymd format
  mutate(
    usecode = usecode %>% as.numeric(),
    fci_dt = ymd(fci_dt) %>% replace_na(ymd(0000 / 00 / 00)),
    build_dt = ymd(build_dt) %>% replace_na(ymd(0000 / 00 / 00))
  ) %>%
  # adding new column called Q-Rating based on the FCI
  mutate(q_rating = case_when(
    fci <= 59 ~ "Q4",
    fci <= 79 ~ "Q3",
    fci <= 89 ~ "Q2",
    TRUE ~ "Q1"
  )) %>%
  # mutate(Category = Category %>% replace_na("Z")) %>%
  mutate(installation = case_when(
    installation %>% str_to_lower() %>% str_detect("butler") ~ "MCB Butler",
    installation %>% str_to_lower() %>% str_detect("mcb camp pendleton") ~ "MCB Pendleton",
    installation %>% str_to_lower() %>% str_detect("mcb camp lejeune") ~ "MCB Lejeune",
    installation %>% str_to_lower() %>% str_detect("mcb hawaii") ~ "MCB Hawaii",
    installation %>% str_to_lower() %>% str_detect("mcas iwakuni") ~ "MCAS Iwakuni",
    installation %>% str_to_lower() %>% str_detect("mcas cherry") ~ "MCAS Cherry Point",
    installation %>% str_to_lower() %>% str_detect("marine corps base quantico") ~ "MCB Quantico",
    installation %>% str_to_lower() %>% str_detect("mcagcc") ~ "MCAGCC 29 Palms",
    installation %>% str_to_lower() %>% str_detect("miramar") ~ "MCAS Miramar",
    installation %>% str_to_lower() %>% str_detect("yuma") ~ "MCAS Yuma",
    installation %>% str_to_lower() %>% str_detect("san diego") ~ "MCRD San Diego",
    installation %>% str_to_lower() %>% str_detect("mcrd beaufort") ~ "MCRD PI",
    installation %>% str_to_lower() %>% str_detect("new river") ~ "MCAS New River",
    installation %>% str_to_lower() %>% str_detect("futenma") ~ "MCAS Futenma",
    installation %>% str_to_lower() %>% str_detect("mcas beaufort") ~ "MCAS Beaufort",
    installation %>% str_to_lower() %>% str_detect("barstow") ~ "MCLB Barstow",
    installation %>% str_to_lower() %>% str_detect("albany") ~ "MCLB Albany",
    installation %>% str_to_lower() %>% str_detect("orleans") ~ "MARFORRES",
    installation %>% str_to_lower() %>% str_detect("washington") ~ "MBW (8th & I)",
    installation %>% str_to_lower() %>% str_detect("garden") ~ "Garden City",
    installation %>% str_to_lower() %>% str_detect("bridgeport") ~ "MWTC Bridgeport",
    installation %>% str_to_lower() %>% str_detect("mujuk") ~ "Camp Mujuk",
    installation %>% str_to_lower() %>% str_detect("mcas camp pendleton") ~ "MCAS Pendleton",
    installation %>% str_to_lower() %>% str_detect("allen") ~ "Camp Elmore",
    installation %>% str_to_lower() %>% str_detect("mcsf") ~ "MCSF Blount Island",
    installation %>% str_to_lower() %>% str_detect("4th mardiv") ~ "HQ 4th MARDIV",
    installation %>% str_to_lower() %>% str_detect("mcsptact") ~ "Kansas City"
  )) %>%
  mutate(RPUID = RPUID %>% as.character()) %>%
  mutate(RM = prv * 0.025)




`%notin%` <- Negate(`%in%`)

utl <- utl %>%
  janitor::clean_names() %>%
  janitor::remove_empty(c("rows"), quiet = TRUE) %>%
  select(
    RPUID = i_nfads_real_property_unique_id,
    use = i_nfads_use_category_code,
    fac_num = i_nfads_facility_number,
    installation = mccs_installation_name,
    program = mccs_business_program,
    asset_name = i_nfads_real_property_asset_name,
    fac_use = i_nfads_facility_use,
    FY2022 = fsm_fy22_sustainment_cost,
    Cat = i_nfads_naf_category,
    adq = i_nfads_adq_area_measure,
    sub = i_nfads_sub_area_measure,
    iadq = i_nfads_iadq_area_measure,
    adq_alt = i_nfads_adq_alternate_measure,
    sub_alt = i_nfads_sub_alternate_measure,
    iadq_alt = i_nfads_iadq_alternate_measure,
    adq_other = i_nfads_adq_other_measure,
    sub_other = i_nfads_sub_other_measure,
    iadq_other = i_nfads_iadq_other_measure
  ) %>%
  separate(use, into = c("use_code", "use_desc"), sep = 6) %>%
  mutate(use_code = use_code %>% as.numeric()) %>%
  # Remove divestments
  filter(RPUID %notin% c(
    21104, 54390, 25139, 24922, 18187, 21378, 21379, 43713, 43714, 35068, 35073, 35080,
    33751, 38891, 38889, 38895, 47139, 40535, 43543, 43544, 43744, 40524, 40529,
    40532, 40526, 40534, 47876, 46374, 39594, 54613
  )) %>%
  mutate(
    adq = adq %>% replace_na(0),
    sub = sub %>% replace_na(0),
    iadq = iadq %>% replace_na(0),
    adq_other = adq_other %>% replace_na(0),
    sub_other = sub_other %>% replace_na(0),
    iadq_other = iadq_other %>% replace_na(0),
    adq_alt = adq_alt %>% replace_na(0),
    sub_alt = sub_alt %>% replace_na(0),
    iadq_alt = iadq_alt %>% replace_na(0),
    FY2022 = FY2022 %>% replace_na(0)
  ) %>%
  mutate(total_measure = adq + sub + iadq,
         alt_total_measure = adq_alt + sub_alt + iadq_alt,
         other_total_measure = adq_other + sub_other + iadq_other) %>%
  group_by(RPUID) %>%

  mutate(use_pct_area = total_measure / sum(total_measure),
         use_pct_other = other_total_measure / sum(other_total_measure),
         use_pct_alt = alt_total_measure / sum(alt_total_measure),
         use_pct_area = use_pct_area %>% replace_na(0),
         use_pct_alt = use_pct_alt %>% replace_na(0),
         use_pct_other = use_pct_other %>% replace_na(0)) %>%
  
  mutate(fac_use_pct = if_else(use_pct_area > 0, use_pct_area, 
                               if_else(use_pct_alt > 0, use_pct_alt, use_pct_other))) %>% 
  ungroup() %>%
  mutate(region = case_when(
    installation %in% c(
      "M00146 MCAS CHERRY POINT NC",
      "M00263 MCRD BEAUFORT PI SC",
      "M60169 MCAS BEAUFORT SC",
      "M62573 MCAS NEW RIVER JAX NC",
      "M67001 MCB CAMP LEJEUNE NC",
      "M67004 MCLB ALBANY GA",
      "M67695 MCSF BLOUNT ISLAND"
    ) ~ "MCIEAST",
    installation %in% c(
      "M00264 MARINE CORPS BASE QUANTICO VA",
      "M67029 MARBKS WASHINGTON DC"
    ) ~ "MCINCR",
    installation %in% c(
      "M00318 MCB HAWAII KANEOHE",
      "M20810 CAMP MUJUK REPUBLIC OF KOREA",
      "M63026 MCAS FUTENMA JA",
      "M67400 MCB CAMP S D BUTLER OKINAWA JA",
      "M62613 MCAS IWAKUNI JA"
    ) ~ "MCIPAC",
    installation %in% c(
      "M00681 MCB CAMP PENDLETON CA",
      "M62204 MCLB BARSTOW CA",
      "M62974 MCAS YUMA AZ",
      "M67604 MCAS CAMP PENDLETON CA",
      "M67865 MCAS MIRAMAR"
    ) ~ "MCIWEST",
    installation %in% c(
      "M00243 MARCORPRCUITDEP SAN DIEGO CA",
      "M64495 MARCORPSMWTC BRIDGEPORT CA",
      "M67399 MCAGCC TWENTYNINE PALMS CA"
    ) ~ "SLTI",
    installation %in% c(
      "M09036 CAMP ALLEN",
      "M67011 MARCORPS DIST 1 GARDEN CITY NY",
      "M67386 MCSPTACT KANSAS CITY MO",
      "M67861 MARCORRESFOR NEW ORLEANS LA",
      "M68479 HDQTRS 4TH MARDIV NEW ORLEANS"
    ) ~ "NONE"
  )) %>%
  mutate(RPUID = RPUID %>% as.character())

fac_mapped <- utl %>%
  inner_join(cat_codes, by = c("use_code" = "use_code")) 
 

fac_mapped <- fac_mapped %>%
  left_join(fac, by = "RPUID") %>% 
  filter(naf_cat %in% c("A", "B", "C", "L"))

# RPUID_count <- fac_mapped %>%
#   group_by(RPUID) %>%
#   count(RPUID)
# 
# fac_mapped <- fac_mapped %>%
#   inner_join((RPUID_count))


df_clean <- fac_mapped %>%
  mutate(
    sus = if_else(naf_cat == "C", FY2022 * 2, FY2022),
    sus = sus %>% replace_na(0)
  ) %>%
  mutate(
    RM_corrected = RM * fac_use_pct) 


df_final <- df_clean %>%
  select(region, installation = installation.x, RPUID, use_code, use_desc, usedesc, naf_cat, op_activity, fac_num, facility_desc, asset_name, fci, fci_dt, q_rating, build_dt, adq, sub, iadq, total_measure, adq_alt, sub_alt, sub_other, alt_total_measure, adq_other, sub_other, iadq_other, other_total_measure, use_pct_area, use_pct_alt, use_pct_other, fac_use_pct, prv, RM, RM_corrected, sus)

write_xlsx(df_final, path = "/Users/barnesj/OneDrive - USMC-MCCS.ORG/Utilization/iNFADS/Data/df_finalv3.xlsx")


```
<br><br>

#### Exploring Costs

```{r}
category <- df_final %>%
  group_by(naf_cat) %>%
  summarise(
    total_sus = sum(sus),
    total_rm = sum(RM_corrected),
    total = sum(sus) + sum(RM_corrected)
  ) %>%
  arrange(desc(total)) %>%
  janitor::adorn_totals()

category

```
<br><br>
```{r}
region <- df_final %>%
  group_by(region) %>%
  summarise(
    total_sus = sum(sus),
    total_rm = sum(RM_corrected),
    total = sum(sus) + sum(RM_corrected)
  ) %>%
  arrange(desc(total)) %>%
  janitor::adorn_totals()

region
```
<br><br>
```{r}

program <- df_final %>%
  group_by(op_activity) %>%
  summarise(
    total_sus = sum(sus),
    total_rm = sum(RM_corrected),
    total = sum(sus) + sum(RM_corrected)
  ) %>%
  arrange(desc(total)) %>%
  janitor::adorn_totals()

program

```
<br><br>

##### Exploring Square Footage

<br><br>
```{r, fig.width = 10, fig.height=5}
program_decade_sqft <- df_final %>%
  mutate(decade = floor_date(build_dt, years(10)) %>% year()) %>%
  group_by(decade, op_activity) %>%
  summarise(total = sum(total_measure)) %>%
  mutate(decade = if_else(is.na(decade), 2020, decade)) %>%
  ggplot(aes(decade, total)) +
  geom_line() +
  # geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~op_activity, scales = "free_y") +
  theme_clean() +
  scale_y_continuous(labels = scales::number) +
  labs(
    y = "Total Measure (SqFt)",
    x = "Decade",
    title = "What is the sqft added in each decade by Program?",
    subtitle = "Decade is based on build date"
  )

program_decade_sqft
```
<br><br>

```{r, fig.width = 10, fig.height=5}
program_year_sqft <- df_final %>%
  mutate(year = floor_date(build_dt, years(1)) %>% year()) %>%
  group_by(year, op_activity) %>%
  filter(year >= 1980, year <= 2020) %>%
  summarise(total = sum(total_measure)) %>%
  # mutate(decade = if_else(is.na(year), 2020, decade)) %>%
  ggplot(aes(year, total)) +
  geom_col() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~op_activity, scales = "free") +
  theme_tq() +
  scale_y_continuous(labels = scales::number) +
  # scale_x_continuous(breaks = c(1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  labs(
    y = "Total Measure (SqFt)",
    x = "Year",
    title = "What is the sqft added each year by Program?",
    subtitle = "Year is based on build date of facility"
  )

program_year_sqft
```
<br><br>

```{r, fig.width = 10, fig.height=5}
region_year_sqft <- df_final %>%
  mutate(year = floor_date(build_dt, years(1)) %>% year()) %>%
  group_by(year, region) %>%
  filter(year >= 1980, year <= 2020) %>%
  summarise(total = sum(total_measure)) %>%
  filter(region != "NONE") %>%
  # mutate(decade = if_else(is.na(year), 2020, decade)) %>%
  ggplot(aes(year, total)) +
  geom_col() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~region, scales = "free") +
  theme_tq() +
  scale_y_continuous(labels = scales::number) +
  # scale_x_continuous(breaks = c(1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  labs(
    y = "Total Measure (SqFt)",
    x = "Year",
    title = "What is the total measure of sqft by Region in a given year?",
    subtitle = "Year is based on build date of facility"
  )

region_year_sqft

```
<br><br>

```{r, fig.width = 10, fig.height=5}

scale <- seq(1900, 2020, by = 10)


df_final %>%
  mutate(decade = floor_date(build_dt, years(10)) %>% year()) %>%
  group_by(decade) %>%
  summarise(sqft = sum(total_measure)) %>%
  mutate(decade = decade %>% as.double(),
         decade = if_else(is.na(decade), 2020, decade)) %>% 
  ungroup() %>% 
  ggplot(aes(decade, sqft)) +
  geom_col(fill = "#2c3e50") +
  scale_x_continuous(breaks = scale) +
  theme_clean() +
  labs(
    title = "New Square Footage by Decade",
    subtitle = "Based on Facilities Build Date",
    y = "SQFT",
    x = "Decade"
  )


df_final %>%
  mutate(decade = floor_date(build_dt, years(10)) %>% year()) %>%
  group_by(decade) %>%
  summarise(sqft = sum(total_measure)) %>%
  ungroup() %>%
  mutate(decade = decade %>% as.double(),
         decade = if_else(is.na(decade), 2020, decade), 
    cumulative = cumsum(sqft)
  ) %>%
  ggplot(aes(decade, cumulative)) +
  geom_area(fill = "#2c3e50") +
  scale_x_continuous(breaks = scale) +
  scale_y_continuous(labels = scales::number_format()) +
  theme_clean() +
  labs(
    title = "Cumulative New Square Footage",
    subtitle = "Based on Facilities Build Date",
    y = "SQFT",
    x = "Decade"
  )

```

<br><br>

```{r, fig.width = 10, fig.height=5}

total_sq_by_region <- df_final %>%
  group_by(region) %>%
  summarise(total_sqft = sum(total_measure)) %>% 
  arrange(desc(total_sqft)) %>% 
  mutate(region = region %>% fct_reorder(total_sqft)) %>% 
  ggplot(aes(region, total_sqft)) +
  geom_col(fill = "#2c3e50") +
  coord_flip() +
  theme_clean() +
  scale_y_continuous(labels = scales::number) +
  labs(
    title = "Total Square Footage by Region",
    y = "Total SqFt",
    x = "Region"
  )

total_sq_by_region

```

<br><br>


```{r, fig.width = 10, fig.height=5}
total_sq_by_installation <- df_final %>%
  group_by(installation) %>%
  summarise(total_sqft = sum(total_measure)) %>% 
  arrange(desc(total_sqft)) %>% 
  mutate(installation = installation %>% fct_reorder(total_sqft)) %>% 
  ggplot(aes(installation, total_sqft)) + 
  geom_col(fill = "#2c3e50") +
  coord_flip() +
  theme_clean() +
   labs(
    title = "Total Square Footage by Installation",
    y = "Total SQFT",
    x = "Installation"
  )

# %>% 
#   gt() %>% 
#   tab_header(title = "Total Sqaure Foot by Instllation") %>% 
#   fmt_number(columns = 2 ,
#              decimals = 0,
#              sep_mark = ",",
#              use_seps = TRUE)

total_sq_by_installation

```

<br><br>


#### Exploring Q-Rating

<br><br>
```{r}

q_group <- df_final %>% distinct(RPUID, .keep_all = TRUE)

op_activity_q <- q_group %>% 
  group_by(op_activity) %>% 
  count(q_rating) %>% 
  mutate(q_rating_pct = n / sum(n))

op_activity_q

```
<br><br>

```{r}
cat_q <- q_group %>% 
  group_by(naf_cat) %>% 
  count(q_rating) %>% 
  mutate(q_rating_pct = n / sum(n))

cat_q

```
<br><br>

```{r}
region_q <- q_group %>% 
  group_by(region) %>% 
  count(q_rating) %>% 
  mutate(q_rating_pct = n / sum(n))  
# %>% 
#   gt() %>% 
#    tab_header(title = "Exploring Q-Rating by Region") %>% 
#   cols_align(align = c("center"))

region_q

```
<br><br>

```{r}
installation_q <- q_group %>% 
  group_by(installation) %>% 
  count(q_rating) %>% 
  mutate(q_rating_pct = n / sum(n)) 
# %>% 
#   gt() %>% 
#    tab_header(title = "Exploring Q-Rating by Installation") %>% 
#   cols_align(align = c("center"))

installation_q

```
<br><br>

##### Exploring the age of facilities

<br><br>


```{r}
age_q <- df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  group_by(q_rating) %>% 
  summarise(avg_age = round(mean(age),0),
            median_age = round(median(age),0),
            sd_age = round(sd(age),0),
            max_age = max(age),
            min_age = min(age),
            range_age = max_age - min_age)
# %>% 
#   gt() %>% 
#   tab_header(title = "Exlploring Facility Age by Q-Rating") %>% 
#   cols_align(align = c("center"))

age_q

```

<br><br>

```{r, fig.width = 10, fig.height=5}
df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  mutate(q_rating = q_rating %>% fct_reorder(age)) %>% 
  ggplot(aes(age, q_rating)) + 
  geom_boxplot() +
  theme_clean() +
  scale_x_reverse() +
  labs(title = "Facility Age by Q-Rating",
       x = "Age",
       y = "Q-Rating")
  
```


<br><br>


```{r}
program_age <- df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  group_by(op_activity) %>% 
  summarise(avg_age = round(mean(age),0),
            median_age = round(median(age),0),
            sd_age = round(sd(age),0),
            max_age = max(age),
            min_age = min(age),
            range_age = max_age - min_age) 
# %>% 
#   gt() %>% 
#   tab_header(title = "Exlploring Facility Age by Program") %>% 
#   cols_align(align = c("center"))

program_age

```

<br><br>

```{r, fig.width = 10, fig.height=5}

df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  mutate(op_activity = op_activity %>% fct_reorder(age)) %>% 
  ggplot(aes(age, op_activity)) + 
  geom_boxplot() +
  theme_clean() +
  scale_x_reverse() +
  labs(title = "Facility Age by Program",
       x = "Age",
       y = "Program")
  
```


<br><br>

```{r}

region_age <- df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  group_by(region) %>% 
  summarise(avg_age = round(mean(age),0),
            median_age = round(median(age),0),
            sd_age = round(sd(age),0),
            max_age = max(age),
            min_age = min(age),
            range_age = max_age - min_age) 
# %>% 
#   gt() %>% 
#   tab_header(title = "Exlploring Facility Age by Region") %>% 
#   cols_align(align = c("center"))

region_age

```

<br><br>

```{r, fig.width = 10, fig.height=5}
df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  mutate(region = region %>% fct_reorder(age)) %>% 
  ggplot(aes(age, region)) + 
  geom_boxplot() +
  theme_clean() +
  scale_x_reverse() +
  labs(title = "Facility Age by Region",
       x = "Age",
       y = "Region")
  
```


<br><br>

```{r}
installation_age <- df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  group_by(installation) %>% 
  summarise(avg_age = round(mean(age),0),
            median_age = round(median(age),0),
            sd_age = round(sd(age),0),
            max_age = max(age),
            min_age = min(age),
            range_age = max_age - min_age)
# %>% 
#   gt() %>% 
#   tab_header(title = "Exlploring Facility Age by Installation") %>% 
#   cols_align(align = c("center"))

installation_age

```

<br><br>

```{r, fig.width = 10, fig.height=5}
df_final %>% 
  mutate(age = today() - build_dt,
         age = round(age/365,0),
         age = age %>% as.numeric()) %>% 
  filter(!is.na(build_dt)) %>% 
  mutate(installation = installation %>% fct_reorder(age)) %>% 
  ggplot(aes(age, installation)) + 
  geom_boxplot() +
  theme_clean() +
  scale_x_reverse() +
  labs(title = "Facility Age by Installation",
       x = "Age",
       y = "Installation")
  
```




